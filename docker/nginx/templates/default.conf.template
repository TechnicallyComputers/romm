# This template is used to generate the default.conf file for the nginx server,
# by using `envsubst` to replace the environment variables in the template with
# their actual values.

# Helper to get scheme regardless if we are behind a proxy or not
map $http_x_forwarded_proto $forwardscheme {
    default $scheme;
    https https;
}

# COEP and COOP headers for cross-origin isolation, which are set only for the
# EmulatorJS player paths, to enable SharedArrayBuffer support (needed for multi-threaded cores).
# Use $request_uri (not $uri) because SPA routes fall back to /index.html via try_files.
map $request_uri $coep_header {
    default        "";
    ~^/rom/.*/ejs(?:\?.*)?$ "require-corp";
    ~^/console/rom/.*/play(?:\?.*)?$ "require-corp";
}
map $request_uri $coop_header {
    default        "";
    ~^/rom/.*/ejs(?:\?.*)?$ "same-origin";
    ~^/console/rom/.*/play(?:\?.*)?$ "same-origin";
}

# enable communication with SFU server for Emulators netplay audio, video, and session management.
# This must be included in the http block, but it is passed in the template file to use a workaround
# in order to include environment varibales in NGINX configuration.
upstream romm_sfu {
    server ${SFU_HOST}:${SFU_PORT};
}

server {
    root /var/www/html;
    listen ${ROMM_PORT};
    ${IPV6_LISTEN}
    server_name localhost;

    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwardscheme;

    # Emulator SFU helper endpoints
    # Use regex locations + proxy_pass without URI so the original URI is preserved.
    # These must come BEFORE the default location block.
    location ~ ^/(?:list|ice|create)$ {
        proxy_pass http://romm_sfu;
    }

    # Room management endpoints (join, leave)
    location ~ ^/(?:join|leave)/ {
        proxy_pass http://romm_sfu;
    }

    # Emulator resolution of web socket to connect to mediasoup
    location ~ ^/socket\.io {
        proxy_pass http://romm_sfu;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        add_header Cache-Control "public, max-age=31536000";
    }

    # Emulator resolution of netplay endpoint on SFU
    location ^~ /netplay/ {
        proxy_pass http://romm_sfu/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location / {
        try_files $uri $uri/ /index.html;
        proxy_redirect off;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods *;
        add_header Access-Control-Allow-Headers *;
        add_header Cross-Origin-Embedder-Policy $coep_header;
        add_header Cross-Origin-Opener-Policy $coop_header;
    }

    # Static files
    location /assets {
        try_files $uri $uri/ =404;
    }

    # OpenAPI for swagger and redoc
    location /openapi.json {
        proxy_pass http://wsgi_server;
    }

    # Backend api calls
    location /api {
        proxy_pass http://wsgi_server;
        proxy_request_buffering off;
        proxy_buffering off;
        client_max_body_size 0;   # Allows files of any size
    }

    # Gunicorn web socket path for romm
    location ~ ^/ws {
        proxy_pass http://wsgi_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # RomM uses Socket.IO under /ws (mounted by the backend at /ws), so /ws/socket.io
    # must be routed to the backend (not the SFU).
    location ^~ /ws/socket.io {
        proxy_pass http://wsgi_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Internally redirect download requests
    location /library/ {
        internal;
        alias "${ROMM_BASE_PATH}/library/";
    }

    # Internal decoding endpoint, used to decode base64 encoded data
    location /decode {
        internal;
        js_content decode.decodeBase64;
    }
}

# Federated Netplay Framework Rules (2026 Standards)

## Architecture Overview

- **System Role**: A multi-emulator netplay framework (EmulatorJS, native Android/PC).
- **Core Components**: RomM (Identity Provider/Metadata), SFU Mesh (mediasoup), Redis (Session State).
- **Identity Model**: Asymmetric RSA (RS256) with JWKS endpoints. No shared secrets.

## Token Strategy

- **JTI-Read**: 15m expiry. Validated via JWT signature + `iss` check. **NEVER** store in Redis.
- **JTI-Write**: 30s expiry. **MUST** store in Redis (`sfu:auth:jti:<token>`).
- **Atomic Operations**: Always use `GETSET` or Lua scripts when marking a JTI as "used" (0 -> 1) to prevent replay attacks.

## Redis Schema Standards

- **Naming**: Use colon-delimited hierarchy: `sfu:room:{id}:meta` or `sfu:auth:jti:{token}`.
- **Data Types**: Use `HSET` for room metadata. Use `SET` with `EX` for JTI tokens.
- **Room Metadata**: Must include `netplay_mode` (0:Stream, 1:Rollback), `host_domain`, and `ai_profile`.

## Federation & Security

- **Domain Verification**: Always verify `iss` (issuer) against the local ACL.
- **JWKS**: SFU must fetch public keys from `{iss}/.well-known/jwks.json` and cache them.
- **mTLS**: Preferred for internal mesh communication between RomM and SFU nodes.

## Coding Preferences

- **Backend (Python/RomM)**: Use asynchronous handlers. Enforce type hinting.
- **SFU (Node.js)**: Use `mediasoup` for low-level RTC. Keep the auth layer middleware-based.
- **Frontend (Vue/JS)**: Implement on-demand token fetching. No background refresh loops for JTIs.

## Rollback Netcode

- **Naive Prediction (Current Implementation)**: Default rollback uses naive prediction (last known input or neutral input).
- **Input History Buffer**: All rollback-related code must support an `input_history` buffer of 60 frames per player.
- **State Snapshots**: Implement circular buffer for state snapshots (save every N frames, configurable).
- **Deterministic Requirement**: Rollback requires deterministic emulation (same ROM, same emulator core/version).

## AI Prediction (Long-Term Future)

- **AI implementation deferred**: AI prediction will be added later, after public adoption.
- **Opt-in data collection**: AI training will require opt-in replay data collection from users.
- **Legal considerations**: Replay data collection from copyrighted ROM gameplay requires legal review before implementation.
- **Hooks preparation**: Prepare hooks for `ai_profile` loading based on RomM genre metadata (for future use).
- **Do not implement AI prediction yet**: Current focus is naive prediction only.

## Container management

- **Podman/Docker build and run commands**: AI is not allowed to run docker or podman build commands or run commands.  You must instead ask the user to manually rebuild or run, and the user will be responsible for making sure environment variables are correct.